name: Compute artifact names
description: Central place for computing the artifact names in the CI builds.

inputs:
  build-name:
    description: The build name (e.g., linux-x86_64, macos-aarch64, etc.)
    required: true

runs:
  using: composite

  steps:
    - name: Check valid build name
      if: >
        ! contains(
          fromJson('[
            "*",
            "linux-x86_64",
            "linux-x86_64-static",
            "macos-x86_64",
            "macos-aarch64",
            "macos-universal"
          ]'),
          inputs.build-name
        )
      shell: sh
      run: |
        echo '::error::Invalid build name provided: ${{ inputs.build-name }}.'
        exit 1

    - name: Set artifact names
      id: set-artifact-names
      shell: sh
      run: |
        echo "artifact-name=wasp-cli-${{ inputs.build-name }}" >> $GITHUB_OUTPUT
        echo "tarball-name=wasp-${{ inputs.build-name }}.tar.gz" >> $GITHUB_OUTPUT

    - name: Set npm triple
      id: set-npm-triple
      if: inputs.build-name != '*' && inputs.build-name != 'macos-universal'
      shell: sh
      run: |
        case '${{ inputs.build-name }}' in
          linux-x86_64) npm_triple='["linux","x64","glibc"]' ;;
          linux-x86_64-static) npm_triple='["linux","x64","musl"]' ;;
          macos-x86_64) npm_triple='["darwin","x64"]' ;;
          macos-aarch64) npm_triple='["darwin","arm64"]' ;;
        esac

        echo "npm-triple=$npm_triple" >>"$GITHUB_OUTPUT"

outputs:
  artifact-name:
    value: ${{ steps.set-artifact-names.outputs.artifact-name }}
    description: "The name of the artifact attached to the CI build."
  tarball-name:
    value: ${{ steps.set-artifact-names.outputs.tarball-name }}
    description: "The name of the tarball inside the artifact."
  npm-triple:
    value: ${{ steps.set-npm-triple.outputs.npm-triple }}
    description: "The JSON-encoded npm triple corresponding to the build (if applicable)."
